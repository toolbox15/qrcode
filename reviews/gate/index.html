<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Your Experience | AIBizService</title>
    <style>
        :root {
            --primary: #6366f1;
            --success: #10b981;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background: var(--dark); 
            color: var(--light); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh;
            padding: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 2.5rem 1.5rem;
            width: 100%;
            max-width: 400px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .tech-circle {
            width: 80px;
            height: 80px;
            background: var(--primary);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 900;
            color: white;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
        }

        h1 { font-size: 1.5rem; margin-bottom: 10px; font-weight: 800; }
        p { color: var(--gray); margin-bottom: 30px; font-size: 1rem; }

        .star-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .star-btn {
            font-size: 3rem;
            cursor: pointer;
            transition: transform 0.2s;
            filter: grayscale(100%);
        }

        .star-btn:hover, .star-btn.active {
            transform: scale(1.2);
            filter: grayscale(0%);
        }

        .feedback-area { margin-top: 20px; display: none; }
        textarea {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
        }

        #status-msg { margin-top: 20px; display: none; color: var(--success); font-weight: 600; }
    </style>
</head>
<body>

    <div class="card">
        <div class="tech-circle" id="initials">?</div>
        <h1 id="headline">How did we do?</h1>
        <p id="subline">Your feedback helps us provide the best service in Chicago.</p>

        <div class="star-container" id="star-box">
            <span class="star-btn" onclick="handleRate(1)">⭐</span>
            <span class="star-btn" onclick="handleRate(2)">⭐</span>
            <span class="star-btn" onclick="handleRate(3)">⭐</span>
            <span class="star-btn" onclick="handleRate(4)">⭐</span>
            <span class="star-btn" onclick="handleRate(5)">⭐</span>
        </div>

        <div id="feedback-form" class="feedback-area">
            <p style="margin-bottom: 15px;">We're sorry to hear that. Please let management know what happened.</p>
            <textarea id="comment" rows="4" placeholder="Your private comments..."></textarea>
            <button class="btn" onclick="submitPrivate()">Send Feedback</button>
        </div>

        <div id="status-msg">Thank you! Your feedback has been sent.</div>
    </div>

    <script>
        const CONFIG = {
            BIN_ID: '6988ac72ae596e708f1ab357',
            API_KEY: '$2a$10$Rs0hwy8AsGdOhHr2VjH3j.voZoeOgcZ1ddCdfzn.63bqiKTGSW1gW'
        };

        let db = null;
        let technician = null;

        // 1. Get ID from URL
        const params = new URLSearchParams(window.location.search);
        const techId = params.get('id');

        // 2. Load Data
        async function init() {
            const r = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}/latest`, {
                headers: { 'X-Master-Key': CONFIG.API_KEY }
            });
            const d = await r.json();
            db = d.record;
            technician = db.qrs.find(q => q.id === techId);

            if (technician) {
                document.getElementById('initials').textContent = technician.name[0].toUpperCase();
                document.getElementById('headline').textContent = `Rate ${technician.name}`;
            }
        }

        // 3. Handle Rating
        async function handleRate(stars) {
            const type = stars === 5 ? "5-Star (Success)" : `Low Rating (${stars} Stars)`;
            
            // Log scan to analytics
            db.scans.unshift({
                qrName: technician ? technician.name : "Unknown",
                company: technician ? technician.company : "Unknown",
                type: type,
                time: new Date().toISOString()
            });

            await updateDB();

            if (stars === 5) {
                document.getElementById('subline').textContent = "Redirecting to Google Reviews...";
                document.getElementById('star-box').style.opacity = "0.3";
                setTimeout(() => {
                    window.location.href = technician.url;
                }, 1000);
            } else {
                document.getElementById('star-box').style.display = "none";
                document.getElementById('feedback-form').style.display = "block";
                document.getElementById('headline').textContent = "Private Feedback";
            }
        }

        async function submitPrivate() {
            const comment = document.getElementById('comment').value;
            db.scans[0].comment = comment; // Add comment to the scan we just logged
            
            await updateDB();
            
            document.getElementById('feedback-form').style.display = "none";
            document.getElementById('status-msg').style.display = "block";
        }

        async function updateDB() {
            await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': CONFIG.API_KEY },
                body: JSON.stringify(db)
            });
        }

        init();
    </script>
</body>
</html>
