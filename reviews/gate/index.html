<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Our Service</title>
    <style>
        :root { --primary: #6366f1; --dark: #0f172a; --text: #1e293b; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; color: var(--text); display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        
        .gate-card { background: white; width: 100%; max-width: 400px; padding: 40px 30px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; border: 1px solid #e2e8f0; }
        .logo { max-width: 200px; max-height: 80px; object-fit: contain; margin-bottom: 20px; }
        h2 { font-size: 1.5rem; margin-bottom: 10px; color: var(--dark); }
        p { color: #64748b; margin-bottom: 30px; }

        .stars { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-direction: row-reverse; }
        .stars input { display: none; }
        .stars label { font-size: 3rem; color: #cbd5e1; cursor: pointer; transition: 0.2s; }
        .stars label:hover, .stars label:hover ~ label, .stars input:checked ~ label { color: #fbbf24; }

        .btn-sms { display: block; width: 100%; padding: 15px; border-radius: 12px; font-weight: 700; text-decoration: none; transition: 0.2s; background: #f8fafc; color: #6366f1; border: 1px solid #e2e8f0; font-size: 0.9rem; margin-top: 20px; }
        .btn-sms:hover { background: #f1f5f9; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="gate-card" id="gate">
        <img id="clientLogo" src="" class="logo hidden">
        <h2 id="companyName">Thank You!</h2>
        <p>How was your experience with <span id="techName" style="font-weight:bold; color:var(--primary);">our technician</span> today?</p>

        <div class="stars">
            <input type="radio" name="star" id="star5" value="5" onclick="handleRate(5)"><label for="star5">★</label>
            <input type="radio" name="star" id="star4" value="4" onclick="handleRate(4)"><label for="star4">★</label>
            <input type="radio" name="star" id="star3" value="3" onclick="handleRate(3)"><label for="star3">★</label>
            <input type="radio" name="star" id="star2" value="2" onclick="handleRate(2)"><label for="star2">★</label>
            <input type="radio" name="star" id="star1" value="1" onclick="handleRate(1)"><label for="star1">★</label>
        </div>

        <a href="#" id="smsBtn" class="btn-sms">Text me this link for later</a>
    </div>

    <script>
        const CONFIG = {
            BIN_ID: '6988ac72ae596e708f1ab357',
            API_KEY: '$2a$10$Rs0hwy8AsGdOhHr2VjH3j.voZoeOgcZ1ddCdfzn.63bqiKTGSW1gW'
        };

        let clientData = null;

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if (!id) return;

            // Default SMS link
            document.getElementById('smsBtn').href = `sms:?&body=Please leave a review for our service: ${window.location.href}`;

            try {
                const r = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}/latest`, { 
                    headers: { 'X-Master-Key': CONFIG.API_KEY } 
                });
                const d = await r.json();
                
                // Find the specific tech badge data
                clientData = d.record.qrs.find(q => q.id === id);

                if (clientData) {
                    document.getElementById('companyName').textContent = clientData.company;
                    document.getElementById('techName').textContent = clientData.name;
                    
                    if (clientData.logo) {
                        let logoUrl = clientData.logo;
                        // Dropbox Fix: Ensure direct download
                        if (logoUrl.includes("dropbox.com") && logoUrl.includes("dl=0")) {
                            logoUrl = logoUrl.replace("dl=0", "dl=1");
                        }
                        const img = document.getElementById('clientLogo');
                        img.src = logoUrl;
                        img.classList.remove('hidden');
                    }
                    
                    // Personalize the SMS reminder
                    document.getElementById('smsBtn').href = `sms:?&body=Review link for ${clientData.company}: ${window.location.href}`;
                }
            } catch (e) { 
                console.error("Error loading gate", e); 
            }
        }

        function handleRate(stars) {
            if (!clientData) return;

            if (stars >= 4) {
                // POSITIVE: Redirect to Google Review Link
                window.location.href = clientData.url;
            } else {
                // NEGATIVE: Redirect to private email
                window.location.href = "mailto:support@aibizservice.com?subject=Service Feedback - Low Rating Alert";
            }
        }

        init();
    </script>
</body>
</html>
