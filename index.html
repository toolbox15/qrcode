<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro QR Dynamic Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1;
            --darker: #020617;
            --light: #f8fafc;
            --gray: #64748b;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--darker); color: var(--light); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        header { text-align: center; margin-bottom: 2rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem; }
        .logo { font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, var(--primary), #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .nav-tabs { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 2rem; background: var(--glass); padding: 0.5rem; border-radius: 16px; }
        .nav-tab { padding: 0.75rem 1.5rem; border: none; background: transparent; color: var(--gray); cursor: pointer; border-radius: 12px; font-weight: 600; flex: 1; }
        .nav-tab.active { color: white; background: var(--primary); }
        
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        .panel { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 24px; padding: 2rem; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--gray); }
        .form-input { width: 100%; padding: 1rem; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--glass-border); border-radius: 12px; color: white; }
        
        .btn { padding: 1rem; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; background: var(--primary); color: white; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-outline { background: transparent; border: 1px solid var(--glass-border); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.8rem; }
        
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .qr-card { background: var(--glass); border: 1px solid var(--glass-border); padding: 1.5rem; border-radius: 20px; display: flex; align-items: center; gap: 1rem; }
        .qr-thumb { width: 60px; height: 60px; background: white; border-radius: 8px; padding: 4px; }
        .qr-info { flex: 1; }
        .qr-name { font-weight: 700; display: block; }
        .qr-url { font-size: 0.8rem; color: var(--gray); word-break: break-all; }
        
        .stats { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .stat-card { flex: 1; background: var(--glass); padding: 1.5rem; border-radius: 20px; text-align: center; border: 1px solid var(--glass-border); }
        .stat-val { font-size: 1.8rem; font-weight: 800; display: block; }
        
        .scan-item { padding: 1rem; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; }
        
        #toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--primary); padding: 1rem 2rem; border-radius: 12px; display: none; z-index: 1000; }
        .sync-indicator { font-size: 0.8rem; color: #34d399; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <div id="loading" style="text-align: center; padding: 5rem;">Loading Cloud Data...</div>
    
    <div id="app-container" class="container" style="display: none;">
        <header>
            <div class="logo">‚óà My Dynamic Tracker</div>
            <div class="sync-indicator" id="syncTag">‚óè Cloud Connected</div>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('creator')">Create</button>
            <button class="nav-tab" onclick="switchTab('tracker')">Manage</button>
            <button class="nav-tab" onclick="switchTab('scans')">Analytics</button>
        </nav>

        <section id="creator-section" class="content-section active">
            <div class="panel">
                <h3>Create Dynamic QR</h3>
                <p style="color:var(--gray); margin-bottom:1.5rem;">You can change the URL of this QR even after printing.</p>
                <form onsubmit="saveQR(event)">
                    <div class="form-group">
                        <label class="form-label">Location/Name</label>
                        <input type="text" id="newName" class="form-input" placeholder="e.g. Front Door" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Destination URL</label>
                        <input type="url" id="newUrl" class="form-input" placeholder="https://..." required>
                    </div>
                    <button type="submit" class="btn" style="width:100%">Generate & Save to Cloud</button>
                </form>
            </div>
            <div id="previewArea" class="panel" style="display:none; text-align:center;">
                <div id="qrcode" style="display:inline-block; background:white; padding:1rem; border-radius:10px;"></div>
                <div style="margin-top:1rem; display:flex; gap:1rem; justify-content:center;">
                    <button class="btn btn-outline" onclick="window.print()">Print</button>
                    <button class="btn btn-outline" onclick="downloadQR()">Download</button>
                </div>
            </div>
        </section>

        <section id="tracker-section" class="content-section">
            <div class="stats">
                <div class="stat-card"><span class="stat-val" id="countQrs">0</span><span style="color:var(--gray)">QR Codes</span></div>
                <div class="stat-card"><span class="stat-val" id="countScans">0</span><span style="color:var(--gray)">Total Scans</span></div>
            </div>
            <div id="qrList" class="qr-grid"></div>
        </section>

        <section id="scans-section" class="content-section">
            <div class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h3>Recent Activity</h3>
                    <button class="btn btn-outline btn-sm" onclick="exportCSV()">Download CSV for AI</button>
                </div>
                <div id="scanLog"></div>
            </div>
        </section>
    </div>

    <div id="toast">Saved!</div>

    <script>
        const CONFIG = {
            BIN_ID: '6988ac72ae596e708f1ab357',
            API_KEY: '$2a$10$Rs0hwy8AsGdOhHr2VjH3j.voZoeOgcZ1ddCdfzn.63bqiKTGSW1gW'
        };

        let db = { qrs: [], scans: [] };

        // INITIALIZE
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('id')) {
                handleRedirect(params.get('id'));
            } else {
                await loadCloudData();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                renderAll();
            }
        });

        // LOAD DATA
        async function loadCloudData() {
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': CONFIG.API_KEY }
                });
                const data = await res.json();
                db = data.record || { qrs: [], scans: [] };
            } catch (e) { showToast("Cloud Error"); }
        }

        // SAVE DATA
        async function saveCloudData() {
            document.getElementById('syncTag').textContent = "‚óè Syncing...";
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': CONFIG.API_KEY },
                    body: JSON.stringify(db)
                });
                document.getElementById('syncTag').textContent = "‚óè Cloud Updated";
            } catch (e) { showToast("Sync Failed"); }
        }

        // REDIRECT LOGIC
        async function handleRedirect(qrId) {
            await loadCloudData();
            const qr = db.qrs.find(q => q.id === qrId);
            if (qr) {
                db.scans.unshift({
                    qrName: qr.name,
                    time: new Date().toISOString(),
                    device: navigator.platform
                });
                await saveCloudData();
                window.location.replace(qr.url);
            } else {
                window.location.replace(window.location.origin + window.location.pathname);
            }
        }

        // SAVE NEW QR
        async function saveQR(e) {
            e.preventDefault();
            const id = Math.random().toString(36).substr(2, 9);
            const name = document.getElementById('newName').value;
            const url = document.getElementById('newUrl').value;
            
            const newEntry = { id, name, url, created: new Date().toISOString() };
            db.qrs.push(newEntry);
            
            const trackingUrl = window.location.origin + window.location.pathname + "?id=" + id;
            
            document.getElementById('previewArea').style.display = 'block';
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), { text: trackingUrl, width: 180, height: 180 });
            
            await saveCloudData();
            renderAll();
            showToast("QR Saved to Cloud!");
        }

        // EDIT QR
        async function editQR(id) {
            const qr = db.qrs.find(q => q.id === id);
            const newUrl = prompt("Enter new destination URL:", qr.url);
            if (newUrl) {
                qr.url = newUrl;
                await saveCloudData();
                renderAll();
                showToast("URL Updated!");
            }
        }

        // DELETE QR
        async function deleteQR(id) {
            if(confirm("Delete this QR and all its stats?")) {
                db.qrs = db.qrs.filter(q => q.id !== id);
                await saveCloudData();
                renderAll();
            }
        }

        // EXPORT CSV FOR AI
        function exportCSV() {
            let csv = "Name,Timestamp,Device\n";
            db.scans.forEach(s => { csv += `${s.qrName},${s.time},${s.device}\n`; });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `scans_${new Date().toLocaleDateString()}.csv`);
            a.click();
        }

        // UI HELPERS
        function switchTab(tab) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab + '-section').classList.add('active');
            event.target.classList.add('active');
        }

        function renderAll() {
            document.getElementById('countQrs').textContent = db.qrs.length;
            document.getElementById('countScans').textContent = db.scans.length;

            const list = document.getElementById('qrList');
            list.innerHTML = db.qrs.map(qr => `
                <div class="qr-card">
                    <img class="qr-thumb" src="https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(window.location.origin + window.location.pathname + "?id=" + qr.id)}">
                    <div class="qr-info">
                        <span class="qr-name">${qr.name}</span>
                        <span class="qr-url">${qr.url}</span>
                    </div>
                    <button class="btn-icon" onclick="editQR('${qr.id}')">‚úèÔ∏è</button>
                    <button class="btn-icon" onclick="deleteQR('${qr.id}')">üóëÔ∏è</button>
                </div>
            `).join('');

            const log = document.getElementById('scanLog');
            log.innerHTML = db.scans.slice(0, 20).map(s => `
                <div class="scan-item">
                    <span><strong>${s.qrName}</strong></span>
                    <span style="color:var(--gray); font-size:0.8rem;">${new Date(s.time).toLocaleString()}</span>
                </div>
            `).join('');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function downloadQR() {
            const img = document.querySelector('#qrcode img');
            const a = document.createElement('a');
            a.href = img.src;
            a.download = 'QR_Code.png';
            a.click();
        }
    </script>
</body>
</html>
