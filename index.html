<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My QR Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #6366f1;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
            --gray: #64748b;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--darker);
            color: var(--light);
            min-height: 100vh;
        }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        
        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .logo {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .cloud-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            color: #34d399;
            margin-top: 1rem;
        }
        
        .cloud-status.offline {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.3);
            color: #fbbf24;
        }
        
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--glass);
            padding: 0.5rem;
            border-radius: 16px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .nav-tab {
            padding: 0.75rem 2rem;
            border: none;
            background: transparent;
            color: var(--gray);
            cursor: pointer;
            border-radius: 12px;
            font-weight: 600;
            flex: 1;
        }
        
        .nav-tab.active {
            color: white;
            background: var(--primary);
        }
        
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        .creator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 768px) { .creator-grid { grid-template-columns: 1fr; } }
        
        .panel {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
        }
        
        .panel-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 0.5rem; }
        .panel-subtitle { color: var(--gray); font-size: 0.9rem; margin-bottom: 1.5rem; }
        
        .form-group { margin-bottom: 1.5rem; }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--light);
            font-size: 1rem;
        }
        
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1rem;
            width: 100%;
            background: var(--primary);
            color: white;
        }
        
        .btn-success { background: #10b981; }
        .btn-secondary { background: rgba(255,255,255,0.1); }
        
        .qr-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 20px;
            border: 2px dashed var(--glass-border);
        }
        
        .qr-preview-container.has-qr {
            border-style: solid;
            border-color: var(--primary);
        }
        
        #qrcode {
            padding: 2rem;
            background: white;
            border-radius: 16px;
            margin-bottom: 1rem;
        }
        
        .qr-label {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .qr-placeholder { text-align: center; color: var(--gray); }
        
        .qr-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .stat-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .stat-value { font-size: 2rem; font-weight: 800; }
        .stat-label { color: var(--gray); font-size: 0.9rem; }
        
        .qr-list { display: grid; gap: 1rem; }
        
        .qr-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1.5rem;
            align-items: center;
        }
        
        .qr-thumb {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 12px;
            padding: 0.5rem;
        }
        
        .qr-thumb img { width: 100%; height: 100%; }
        
        .qr-name { font-weight: 700; font-size: 1.2rem; }
        .qr-location { color: var(--gray); font-size: 0.9rem; }
        
        .qr-actions-list { display: flex; gap: 0.5rem; }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            cursor: pointer;
        }
        
        .scan-log { max-height: 500px; overflow-y: auto; }
        
        .scan-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--glass-border);
        }
        
        .empty-state { text-align: center; padding: 4rem; color: var(--gray); }
        
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            display: none;
            z-index: 2000;
        }
        
        .toast.show { display: block; }
        
        /* Sync Button */
        .sync-btn {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            z-index: 100;
        }
        
        .sync-btn:hover { background: rgba(99, 102, 241, 0.2); }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .sync-btn.spinning span:first-child {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="app-container" style="display: none;">
        <div class="container">
            <header>
                <div class="logo">‚óà My QR Tracker</div>
                <div class="cloud-status" id="cloudStatus">
                    <span>‚òÅÔ∏è</span> Cloud Sync: <span id="syncStatus">Local Mode</span>
                </div>
            </header>

            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('creator')">Create & Print</button>
                <button class="nav-tab" onclick="switchTab('tracker')">My QR Codes</button>
                <button class="nav-tab" onclick="switchTab('scans')">Scan Log</button>
            </nav>

            <section id="creator-section" class="content-section active">
                <div class="creator-grid">
                    <div class="panel">
                        <div class="panel-title">Create New QR Code</div>
                        <div class="panel-subtitle">Name it by location for tracking</div>
                        
                        <form id="qrForm" onsubmit="generateQR(event)">
                            <div class="form-group">
                                <label class="form-label">QR Code Name / Location *</label>
                                <input type="text" class="form-input" id="qrName" placeholder="e.g., Car-Window" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Destination URL *</label>
                                <input type="url" class="form-input" id="qrContent" placeholder="https://instagram.com/yourname" required>
                            </div>
                            
                            <button type="submit" class="btn">Generate QR Code</button>
                        </form>
                    </div>
                    
                    <div class="panel">
                        <div class="panel-title">Preview</div>
                        <div class="panel-subtitle">Scan to test instant redirect</div>
                        
                        <div class="qr-preview-container" id="previewContainer">
                            <div class="qr-placeholder">
                                <p>Enter details and click Generate</p>
                            </div>
                        </div>
                        
                        <div class="qr-actions" id="qrActions" style="display: none;">
                            <button class="btn btn-success" onclick="printQR()">Print</button>
                            <button class="btn" onclick="downloadQR()">Download</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="tracker-section" class="content-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalQrs">0</div>
                        <div class="stat-label">QR Codes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalScans">0</div>
                        <div class="stat-label">Total Scans</div>
                    </div>
                </div>

                <div class="panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div class="panel-title">My QR Codes</div>
                        <button class="btn" onclick="switchTab('creator')" style="width: auto;">+ Create New</button>
                    </div>
                    <div id="qrList" class="qr-list"></div>
                </div>
            </section>

            <section id="scans-section" class="content-section">
                <div class="panel">
                    <div class="panel-title">Scan Activity</div>
                    <div id="scanLog" class="scan-log"></div>
                </div>
            </section>
        </div>
        
        <!-- Sync Button -->
        <button class="sync-btn" id="syncBtn" onclick="syncNow()">
            <span>üîÑ</span> Sync Now
        </button>
        
        <div class="toast" id="toast">Success!</div>
    </div>

    <script>
        // ==========================================
        // CONFIG - PASTE YOUR VALUES HERE
        // ==========================================
        const CONFIG = {
            BIN_ID: '6988ac72ae596e708f1ab357',      // <-- PASTE BIN ID HERE
            API_KEY: '$2a$10$Rs0hwy8AsGdOhHr2VjH3j.voZoeOgcZ1ddCdfzn.63bqiKTGSW1gW', // <-- PASTE MASTER KEY HERE
            USE_CLOUD: false                  // <-- CHANGE TO true
        };

        // Data storage
        let qrDatabase = JSON.parse(localStorage.getItem('myQRTracker')) || [];
        let scanDatabase = JSON.parse(localStorage.getItem('myQRScans')) || [];
        let currentQR = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const qrData = urlParams.get('data');
            
            if (qrData) {
                // Someone scanned - redirect immediately
                handleScan(qrData);
            } else {
                // Show dashboard
                document.getElementById('app-container').style.display = 'block';
                updateCloudStatus();
                updateStats();
                renderQRList();
                renderScanLog();
            }
        });

        // Update cloud status display
        function updateCloudStatus() {
            const statusEl = document.getElementById('cloudStatus');
            const syncStatus = document.getElementById('syncStatus');
            
            if (CONFIG.USE_CLOUD && CONFIG.BIN_ID !== 'your-bin-id-here') {
                syncStatus.textContent = 'Active';
                statusEl.classList.remove('offline');
            } else {
                syncStatus.textContent = 'Local Mode';
                statusEl.classList.add('offline');
            }
        }

        // Sync with cloud
        async function syncNow() {
            if (!CONFIG.USE_CLOUD || CONFIG.BIN_ID === 'your-bin-id-here') {
                showToast('Cloud not configured. Add your Bin ID and API Key first.');
                return;
            }
            
            const btn = document.getElementById('syncBtn');
            btn.classList.add('spinning');
            
            try {
                // Fetch from cloud
                const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': CONFIG.API_KEY }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.record && data.record.scans) {
                        // Merge cloud scans with local
                        const cloudScans = data.record.scans;
                        const localScans = scanDatabase;
                        
                        // Combine and remove duplicates
                        const allScans = [...localScans, ...cloudScans];
                        const uniqueScans = allScans.filter((scan, index, self) => 
                            index === self.findIndex(s => 
                                s.timestamp === scan.timestamp && s.qrName === scan.qrName
                            )
                        );
                        
                        scanDatabase = uniqueScans.sort((a, b) => 
                            new Date(b.timestamp) - new Date(a.timestamp)
                        );
                        
                        localStorage.setItem('myQRScans', JSON.stringify(scanDatabase));
                        renderScanLog();
                        updateStats();
                        showToast('Synced with cloud!');
                    }
                } else {
                    showToast('Sync failed - check your API key');
                }
            } catch (error) {
                console.error('Sync error:', error);
                showToast('Sync failed - using local data');
            } finally {
                btn.classList.remove('spinning');
            }
        }

        // Handle scan - instant redirect with background tracking
        function handleScan(encodedData) {
            try {
                const jsonString = atob(decodeURIComponent(encodedData));
                const qrData = JSON.parse(jsonString);
                
                // Track in background
                const scan = {
                    qrName: qrData.name,
                    targetUrl: qrData.url,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    screenSize: `${screen.width}x${screen.height}`
                };
                
                // Save scan locally
                scanDatabase.unshift(scan);
                localStorage.setItem('myQRScans', JSON.stringify(scanDatabase));
                
                // Try to sync to cloud (fire and forget)
                if (CONFIG.USE_CLOUD && CONFIG.BIN_ID !== '6988ac72ae596e708f1ab357') {
                    syncScanToCloud(scan);
                }
                
                // INSTANT REDIRECT
                window.location.replace(qrData.url);
                
            } catch (e) {
                window.location.href = window.location.origin;
            }
        }

        // Sync single scan to cloud
        async function syncScanToCloud(scan) {
            try {
                // Get current cloud data
                const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': CONFIG.API_KEY }
                });
                
                let cloudData = { scans: [] };
                if (response.ok) {
                    const data = await response.json();
                    cloudData = data.record || { scans: [] };
                }
                
                // Add new scan
                cloudData.scans.unshift(scan);
                cloudData.lastUpdated = new Date().toISOString();
                
                // Save back to cloud
                await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': CONFIG.API_KEY
                    },
                    body: JSON.stringify(cloudData)
                });
            } catch (e) {
                console.log('Cloud sync failed, scan saved locally');
            }
        }

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(tab + '-section').classList.add('active');
            event.target.classList.add('active');
            
            if (tab === 'tracker') {
                updateStats();
                renderQRList();
            } else if (tab === 'scans') {
                renderScanLog();
            }
        }

        // Generate QR
        function generateQR(e) {
            e.preventDefault();
            
            const name = document.getElementById('qrName').value;
            const targetUrl = document.getElementById('qrContent').value;
            
            // Create QR data
            const qrPayload = {
                name: name,
                url: targetUrl
            };
            
            const encodedData = encodeURIComponent(btoa(JSON.stringify(qrPayload)));
            const currentPageUrl = window.location.href.split('?')[0];
            const trackingUrl = currentPageUrl + '?data=' + encodedData;
            
            // Save to database
            currentQR = {
                id: Date.now().toString(),
                name: name,
                targetUrl: targetUrl,
                trackingUrl: trackingUrl,
                createdAt: new Date().toISOString()
            };
            
            qrDatabase.push(currentQR);
            localStorage.setItem('myQRTracker', JSON.stringify(qrDatabase));
            
            // Generate QR code
            const container = document.getElementById('previewContainer');
            container.innerHTML = '';
            container.classList.add('has-qr');
            
            const qrDiv = document.createElement('div');
            qrDiv.id = 'qrcode';
            container.appendChild(qrDiv);
            
            // Use QRCode library
            new QRCode(qrDiv, {
                text: trackingUrl,
                width: 200,
                height: 200
            });
            
            // Add label
            const label = document.createElement('div');
            label.className = 'qr-label';
            label.textContent = name;
            qrDiv.appendChild(label);
            
            document.getElementById('qrActions').style.display = 'flex';
            
            showToast('QR Code created!');
            updateStats();
        }

        // Print QR
        function printQR() {
            window.print();
        }

        // Download QR
        function downloadQR() {
            const qrCanvas = document.querySelector('#qrcode canvas');
            if (!qrCanvas) return;
            
            const link = document.createElement('a');
            link.download = 'QR-' + currentQR.name + '.png';
            link.href = qrCanvas.toDataURL();
            link.click();
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalQrs').textContent = qrDatabase.length;
            document.getElementById('totalScans').textContent = scanDatabase.length;
        }

        // Render QR list
        function renderQRList() {
            const container = document.getElementById('qrList');
            
            if (qrDatabase.length === 0) {
                container.innerHTML = '<div class="empty-state">No QR codes yet</div>';
                return;
            }
            
            container.innerHTML = qrDatabase.map(qr => {
                const scans = scanDatabase.filter(s => s.qrName === qr.name).length;
                return `
                    <div class="qr-card">
                        <div class="qr-thumb">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qr.trackingUrl)}" alt="QR">
                        </div>
                        <div>
                            <div class="qr-name">${qr.name}</div>
                            <div class="qr-location">${scans} scans ‚Ä¢ ${qr.targetUrl}</div>
                        </div>
                        <div class="qr-actions-list">
                            <button class="btn-icon" onclick="deleteQR('${qr.id}')">√ó</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Delete QR
        function deleteQR(id) {
            if (confirm('Delete?')) {
                qrDatabase = qrDatabase.filter(q => q.id !== id);
                localStorage.setItem('myQRTracker', JSON.stringify(qrDatabase));
                updateStats();
                renderQRList();
            }
        }

        // Render scan log
        function renderScanLog() {
            const container = document.getElementById('scanLog');
            
            if (scanDatabase.length === 0) {
                container.innerHTML = '<div class="empty-state">No scans yet. Scan a QR code to see it here!</div>';
                return;
            }
            
            container.innerHTML = scanDatabase.map(scan => `
                <div class="scan-item">
                    <div>
                        <strong>${scan.qrName}</strong>
                        <div style="color: var(--gray); font-size: 0.85rem;">
                            ${scan.platform || 'Unknown'} ‚Ä¢ ${new Date(scan.timestamp).toLocaleString()}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show toast
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
